#include "head.h"
/*
	特别感谢(好像是网上唯一的资料):
	https://github.com/hzqst/unicorn_pe/tree/master/unicorn_pe
*/

void InitGlobalVar() {
	g_global = new globalvar();
	g_pe = new pe_action();
	g_virtual = new virtual_helper();
	
	cs_open(CS_ARCH_X86, CS_MODE_64, &g_global->hanlde_capstone);
	uc_open(UC_ARCH_X86, UC_MODE_64, &g_global->uc_engine);
	/*
		映射系统环境
	*/
	g_virtual->init_virtual_processer();
	g_virtual->init_virtual_pte();
	uint64_t m_KSharedUserDataBase = 0x7FFE0000;
	uint64_t m_KSharedUserDataEnd = 0x7FFF0000;
	uc_mem_map(g_global->uc_engine, m_KSharedUserDataBase, PAGE_SIZE, UC_PROT_READ);
	uc_mem_write(g_global->uc_engine, m_KSharedUserDataBase, (void*)m_KSharedUserDataBase, PAGE_SIZE);
	
}

int main(int argc, char** argv, char** envp)
{
	InitGlobalVar();
	//加载PE解析导入表导出表区段结构到内存里
	g_pe->load_pe(FILE);
	//初始化环境、run
	g_virtual->init_virtual_helper();
	return 0;
}
